{% extends 'base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>
    /* 검색 영역 */
    .searchForm {
        padding: 20px;
    }

    /* 그리드 영역 */
    .dataGrid {
        padding: 20px;
        overflow: auto; 
    }

    .tableGrid {
        border-collapse: collapse;
        border: 1px solid;
        white-space: nowrap;
        text-align: center;
    }

    .tableGrid thead { 
        position: -webkit-sticky; 
        position: sticky; 
        top: 0; 
        z-index: 1; 
    }
    .tableGrid th:first-child,
    .tableGrid td:first-child { 
        position: -webkit-sticky; 
        position: sticky; 
        left: 0; 
    }
    .tableGrid th:nth-child(2),
    .tableGrid td:nth-child(2) { 
        position: -webkit-sticky; 
        position: sticky; 
        left: 94px; 
    }
    .tableGrid th:nth-child(3),
    .tableGrid td:nth-child(3) { 
        position: -webkit-sticky; position: sticky; left: 156px; 
    }

    th, td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    th {
        background-color: #333;
        color: white;
        text-align: center;
    }

    tr:hover {background-color: coral;}

    /* 업로드 영역 */
    .input-group {
        padding: 20px;
    }
</style>

{% if user.is_authenticated %} 
    <h3>CSD Daily</h3>
    <div class="searchForm">
        <input type="month" id="monthSearch" class="searchMonth" value="2022-11">
        <input type="button" id="btnSearch" value="Search" onclick="searchDaily()">
    </div>
    <div class="dataGrid">
        <table class="tableGrid" id="myTable">
            <thead>
                <tr id="thTr">
                    <th><B>商品代號</B></th>
                    <th><B>條碼</B></th>
                    <th><B>品名</B></th>
                </tr>
            </thead>
            <tbody>
                {% for inv in sumDaily %}
                <tr id="tdTr">
                    <td>{{inv.prd_code.prd_code}}</td>
                    <td>{{inv.prd_code.prd_barcode}}</td>
                    <td>{{inv.prd_code.prd_name}}</td>
                </tr>
                <p id="datedata" hidden>{{inv.sum_d_date}}</p>
                <p id="saledata" hidden>{{inv.sum_d_sale | slice:":2"}}</p>
                {% endfor %}
                <tbody>
        </table>
    </div>

    <form action="/csd/upload/" method="POST" enctype="multipart/form-data">{% csrf_token %}
        <div class="input-group">
            <input type="file" class="form-control" id="fileInput" name="fileInput">
            <input type="submit" class="btn btn-success btn-lg" id="submitBtn" value="Upload File" disabled>
        </div>
    </form>

{% else %}
    <meta http-equiv="refresh" content="0; url='/users/login'" />
{% endif %}
<script>
    window.onload=function(){
        searchDaily();
    }
    
    // 파일 선택시에만 버튼 활성화
    document.getElementById('fileInput').addEventListener('input', function(event) {
        document.getElementById('submitBtn').disabled = !this.value;
    }, false);

    // 검색창 달력 현재 달로 디폴트 세팅 
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = ("0" + (now.getMonth() + 1)).slice(-2);
    const defaultMonth = currentYear + "-" + currentMonth
    document.getElementById("monthSearch").value = defaultMonth;
    
    function searchDaily() {
        // 테이블 th에 일 출력 (달력에 선택된 달의 마지막 일짜까지 출력)
        const monthSearch = document.getElementById('monthSearch').value;
        const lastDay = new Date( now.getFullYear(), ( monthSearch.substr(5)), 0 );
        const lastDate = lastDay.getDate(); // 해당 월의 마지막일자
        const mytable = document.getElementById('myTable');
        const thTr = document.getElementById('thTr');
        // 날짜 arr
        const arrNum = new Array();
        for (var i = 0; i < lastDate; i++){
            let th = document.createElement('th');
            th.innerHTML = (i + 1);
            thTr.append(th);

            arrNum.push(i+1);
        }
        let thT = document.createElement('th')
        thT.innerHTML = "Total";
        thTr.append(thT);
        let thA = document.createElement('th')
        thA.innerHTML = "Average";
        thTr.append(thA);

        // 테이블 td에 데이터 출력
        const tdTr = document.getElementById('tdTr');
        const arrSet = "{{sumSet}}".substr(1).slice(0,-1).split(",");
        // arrSet 1: 31, 2: 53, 3: 79, 6: 197, 7: 227, 8: 249, 9: 262, 10: 285, 13: 392, 14: 418, 15: 439
        
        console.log("arrSet "+arrSet);
        //const datedata = document.getElementById('datedata').innerHTML;
        //const saledata = document.getElementById('saledata').innerHTML;
        //var arrDate = "{{sumDate}}".substr(1).slice(0,-1).split(",");
        //var arrSale = "{{sumSale}}".substr(1).slice(0,-1).split(",");
        //console.log("arrDate "+arrDate);
        //console.log("arrSale "+arrSale);
        for (var j = 0; j < lastDate; j++){
            let setDate = arrSet[j].split(":")[0].trim();
            
            console.log("arrNum "+arrNum);
            let td = document.createElement('td');
            if(setDate.includes(j+1)) {
                console.log("setDate "+arrSet[j].split(":")[0].trim());
                console.log("includes(j+1) "+(3+1));
                td.innerHTML = arrSet[j+1].split(":")[1].trim();
                tdTr.append(td);
            } else {
                td.innerHTML = '-';
                tdTr.append(td);
            }
        }

    }

</script>
{% endblock %}