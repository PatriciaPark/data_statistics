{% extends 'base.html' %}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="{% static 'css/csm.css' %}">
<link rel="stylesheet" href="{% static 'css/loading.css' %}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% if user.is_authenticated %} 
    <h1 class="h3 mb-4 text-gray-800">
        <i class="fas fa-location-arrow"></i> å…¨è¯ > DATA > Monthly > <B>{{year}}å¹´{{month}}æœˆ</B>
    </h1>
    {% comment %} <div data-preset="energy" class="ldBar label-center" data-value="35"></div> {% endcomment %}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <form method="GET" id="selectForm">
                <div class="searchForm">
                    <input type="month" name="input-month" id="monthSearch" class="bg-light border-1 searchMonth">
                    {% comment %} select box (location-city-store) {% endcomment %}
                    <select name="add-loc" id="selectAddLoc" class="select">
                        <option value="all" selected>Location</option>
                        {% for loc in loc %}
                        <option value="{{loc.str_loc}}">{{loc.str_loc}}</option>
                        {% endfor %}
                    </select>
                    <select name="add-city" id="selectAddCity" class="select">
                        <option value="all" selected>City</option>
                        {% for city in city %}
                        <option value="{{city.str_city}}">{{city.str_city}}</option>
                        {% endfor %}
                    </select>
                    <select name="add-str" id="selectAddStr" class="select">
                        <option value="all" selected>Store</option>
                        {% for str in str %}
                        <option value="{{str.str_name}}">{{str.str_name}}</option>
                        {% endfor %}
                    </select>
                    {% comment %} select box (product list) {% endcomment %}                    
                    <select name="input-prd" id="selectSearch" class="select" onChange="selectedPrd()">
                        <option value="" selected>æ‰€æœ‰ç”¢å“</option>
                        {% for prd in product %}
                        <option value="{{prd.prd_code}}">{{prd.prd_name|cut:' '}}</option>
                        {% endfor %}
                    </select>
                    <select name="input-sort" id="selectSort" class="select" onChange="selectedSort()">
                        <option value="" selected>é™åºæ’åˆ—</option>
                        <option value="strname">é–€å¸‚åç¨±</option>
                        <option value="prdSave">ä¸Šå­˜é‡</option>
                        <option value="prdBuy">é€²è²¨é‡</option>
                        <option value="prdReturn">é€€è²¨é‡</option>
                        <option value="prdSale">éŠ·è²¨é‡</option>
                        <option value="prdStock">åº«å­˜é‡</option>
                        <option value="prdStockMon">åº«å­˜æœˆä»½</option>
                    </select>
                    <input type="submit" id="btnSearch" class="btn btn-primary" value="ğŸ”ï¸">
                    <input type="reset" id="btnReset" value="Reset" class="btn btn-secondary" onclick="resetForm()">
                </div>
            </form>
        </div>
        <div class="card shadow mb-4">
            <p id="pCount">æ•¸æ“šæ•¸ : {{monthData.count}} æ¢</p>
            <div class="dataGrid">
                <table class="tableGrid">
                    <thead>
                        <tr id="thTr">
                            <th class="bg-gradient-primary"><B>å€åŸŸ</B></th>
                            <th class="bg-gradient-primary"><B>ç¸£å¸‚</B></th>
                            <th class="bg-gradient-primary"><B>é–€å¸‚ä»£è™Ÿ</B></th>
                            <th class="bg-gradient-primary"><B>é–€å¸‚åç¨±</B></th>
                            <th class="bg-gradient-primary"><B>ä»£è™Ÿ</B></th>
                            <th class="bg-gradient-primary"><B>æ¢ç¢¼</B></th>
                            <th class="bg-gradient-primary"><B>å“å/è¦æ ¼</B></th>
                            <th class="bg-gradient-primary"><B>ä¸Šå­˜é‡</B></th>
                            <th class="bg-gradient-primary"><B>é€²è²¨é‡</B></th>
                            <th class="bg-gradient-primary"><B>é€€è²¨é‡</B></th>
                            <th class="bg-gradient-primary"><B>éŠ·è²¨é‡</B></th>
                            <th class="bg-gradient-primary"><B><abbr title="= éŠ·è²¨é‡/ç•¶æœˆç¸½å¤©æ•¸">æ¯æ—¥éŠ·è²¨ç¸½è¨ˆ</abbr></B></th>
                            <th class="bg-gradient-primary"><B><abbr title="= éŠ·è²¨é‡/æ¯æ—¥éŠ·è²¨ç¸½è¨ˆ">èª¤å·®å€¼(%)</abbr></B></th>
                            <th class="bg-gradient-primary"><B>åº«å­˜é‡</B></th>
                            <th class="bg-gradient-primary"><B><abbr title="= åº«å­˜é‡/éŠ·è²¨é‡">åº«å­˜æœˆä»½</abbr></B></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if monthData %}
                        <tr>
                            <td colspan="7"><B>Total</B></td>
                            <td><B>{{sumSave.sum_m_save__sum}}</B></td>
                            <td><B>{{sumBuy.sum_m_buy__sum}}</B></td>
                            <td><B>{{sumReturn.sum_m_return__sum}}</B></td>
                            <td><B>{{sumSale.sum_m_sale__sum}}</B></td>
                            <td><B>{{ttlSumDl|floatformat:2}}</B></td>
                            <td><B>{{ttlerr|floatformat:2}}</B></td>
                            <td><B>{{sumStock.sum_m_stock__sum}}</B></td>
                            <td><B>{% widthratio sumStock.sum_m_stock__sum sumSale.sum_m_sale__sum 1 %}</B></td>
                        </tr>
                        {% for data in monthData %}
                        <tr id="tdTr">
                            <td>{{data.str_code.str_loc}}</td>
                            <td>{{data.str_code.str_city}}</td>
                            <td>{{data.str_code.str_code}}</td>
                            <td>{{data.str_code.str_name}}</td>
                            <td>{{data.prd_code.prd_code}}</td>
                            <td>{{data.prd_code.prd_barcode}}</td>
                            <td>{{data.prd_code.prd_name}}</td>
                            <td>{{data.sum_m_save}}</td>
                            <td>{{data.sum_m_buy}}</td>
                            <td>{{data.sum_m_return}}</td>
                            <td>{{data.sum_m_sale}}</td>
                            <td><B>{{data.sum_m_sale_ttl}}</B></td>

                            {%if data.sum_m_sale_err == None %}
                                <td><B>-</B></td>
                            {% else %}
                                <td><B>{{data.sum_m_sale_err}}</B></td>
                            {% endif %}

                            <td>{{data.sum_m_stock}}</td>

                            {% comment %} ì›”ì¬ê³ ìœ¨ 6ì´ìƒ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ {% endcomment %}
                            {%if data.sum_m_stock_mon == None %}
                                <td><B>-</B></td>
                            {% else %}
                                {%if data.sum_m_stock_mon >= 6 %}
                                    <td style="color:red">{{data.sum_m_stock_mon}}</td>
                                {% else %}
                                    <td>{{data.sum_m_stock_mon}}</td>
                                {% endif %}
                            {% endif %}
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="15"><B>No Data</B></td>
                        </tr>
                        {% endif %}
                    <tbody>
                </table>
            </div>
        </div>
        <form action="/csm/upload/" method="POST" enctype="multipart/form-data">{% csrf_token %}
            <p id="pInput" class="text-danger">* æ–‡ä»¶åå¿…é ˆç­‰æ–¼ 'å…¨è¯112-01'ã€'å…¨è¯112-02'ç­‰ </p>
            <div class="input-group">
                <input type="file" class="form-control" id="fileInput" name="fileInput">
                <input type="submit" class="btn btn-primary" id="submitBtn" value="Upload File" disabled>
            </div>
        </form>
    </div>
{% else %}
    <meta http-equiv="refresh" content="0; url='/users/login'" />
{% endif %}
<script>
    const yearData = "{{year}}"
    const monthData = "{{month}}";
    const prdData = "{{prdcode}}";
    const sortData = "{{sort}}";

    // error message
    {% for message in messages %}
        alert("{{message}}");
    {% endfor %}
</script>
<script src="{% static 'script/csm.js' %}"></script>
{% endblock %}